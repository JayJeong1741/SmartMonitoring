<!DOCTYPE html>
<html th:replace="~{layouts/base::html(main=~{::main})}" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>ì‹ í˜¸ë“± ëª¨ë‹ˆí„°ë§ - ìƒì„¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100 font-sans">
<main>
    <!-- ì‹ í˜¸ë“± ìƒì„¸ ì •ë³´ -->
    <section class="pt-20 pb-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-6">ì‹ í˜¸ë“± ìƒì„¸ ì •ë³´</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- íƒ­ ë©”ë‰´ ë° ì½˜í…ì¸  -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                <div class="flex border-b border-gray-200">

                    <button class="tab-button-main px-4 py-2 text-gray-600 font-medium focus:outline-none active text-blue-600 border-b-2 border-blue-600" data-tab="video">ğŸ“¹ ì‹¤ì‹œê°„ ì˜ìƒ</button>
                    <button class="tab-button-main px-4 py-2 text-gray-600 font-medium focus:outline-none" data-tab="map">ğŸ“ ì‹ í˜¸ë“± ìœ„ì¹˜</button>
                </div>
                <div class="tab-content mt-4">
                    <!-- ì‹¤ì‹œê°„ ì˜ìƒ íƒ­ -->
                    <div id="video" class="tab-pane-main block">
                        <div class="relative w-full h-96 bg-gray-800 rounded-lg overflow-hidden">
                            <img id="video-frame" class="w-full h-full object-cover">
                            <div class="absolute bottom-4 left-4 right-4 flex justify-center space-x-2">
                                <button onclick="play()" class="bg-gray-700 text-white px-3 py-1 rounded-md hover:bg-gray-600">â–¶ ì¬ìƒ</button>
                                <button onclick="stop()" class="bg-gray-700 text-white px-3 py-1 rounded-md hover:bg-gray-600">âšâš ì¼ì‹œì •ì§€</button>
                            </div>
                        </div>
                    </div>
                    <!-- ì§€ë„ íƒ­ -->
                    <div id="map" class="tab-pane-main invisible absolute top-0 left-0 w-full opacity-0 pointer-events-none">
                        <div id="map-container" class="w-full h-96 rounded-lg relative z-10"></div>
                    </div>
                </div>
            </div>
            <!-- ìƒíƒœ ì •ë³´ ë° ì‚¬ì´ë“œë°” -->
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-lg shadow-md" th:each="trafficLight : ${trafficLight}">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">â„¹ï¸ ìƒíƒœ ì •ë³´</h3>
                    <p><strong>ì‹ í˜¸ë“± ID:</strong> <span th:text="|TL00${trafficLight.id.id}|">TL001</span></p>
                    <p><strong>ìœ„ì¹˜:</strong> <span th:text="${trafficLight.sName}">ê´‘í™”ë¬¸</span></p>
                    <p><strong>ìœ„ë„:</strong> <span th:text="${trafficLight.lat}">37.00</span></p>
                    <p><strong>ê²½ë„:</strong> <span th:text="${trafficLight.lng}">127.00</span></p>
                    <div class="flex items-center">
                        <strong class="mr-2">ìƒíƒœ:</strong>
                        <!-- ë°°ê²½ ì˜¤ë²„ë ˆì´ -->
                        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 hidden"></div>

                        <div class="flex items-center">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-sm font-medium"
                                  th:classappend="
                                  ${trafficLight.state} == 0 ? ' bg-green-100 text-green-800' :
                                  (${trafficLight.state} == 1 ? ' bg-red-100 text-red-800' :
                                  (${trafficLight.state} == 2 ? ' bg-yellow-100 text-yellow-800' : ''))">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <g th:switch="${trafficLight.state}">
                                        <g th:case="0">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </g>
                                        <g th:case="1">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M5.07 19h13.86A2.07 2.07 0 0021 16.93V7.07A2.07 2.07 0 0018.93 5H5.07A2.07 2.07 0 003 7.07v9.86A2.07 2.07 0 005.07 19z"/>
                                        </g>
                                        <g th:case="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/>
                                        </g>
                                    </g>
                                </svg>
                                <span th:switch="${trafficLight.state}">
                                    <span th:case="0">ì •ìƒ</span>
                                    <span th:case="1">ìœ„ê¸‰</span>
                                    <span th:case="2">ì ê²€</span>
                                </span>
                            </span>

                        </div>
                    </div>
                    <p><strong>ìµœê·¼ ìœ„ê¸‰ìƒí™©:</strong>
                        <span th:text="${#temporals.format(trafficLight.lastEmergency, 'yyyyë…„ MMì›” ddì¼ HHì‹œ mmë¶„')}">2025-01-01 00:00:00</span>
                    </p>
                    <button id="stateChange" onclick="togglePopup('popupMenu')" class="mt-4 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">ìƒíƒœ ë³€ê²½</button>
                    <button id="alarmToWorker" onclick="togglePopup('popupMenuForAlarm')" class="mt-2 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">ì¸ê·¼ í˜„ì¥ê·¼ë¬´ì</button>
                </div>


                <div id="popupMenu" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white shadow-2xl rounded-xl p-6 z-50 w-96 max-w-[90%] transition-all duration-300 opacity-0 scale-95">
                    <div class="flex items-center mb-4">
                        <svg class="w-6 h-6 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <h3 class="text-xl font-bold text-gray-800">ìƒíƒœ ë³€ê²½</h3>
                    </div>

                    <select id="stateSelect" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-700 cursor-pointer transition duration-200 hover:bg-gray-100"
                            style="background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2220%22%20height%3D%2220%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cpath%20d%3D%22M5%206l5%205%205-5%202%201-7%207-7-7%202-1z%22%20fill%3D%22%23555%22/%3E%3C/svg%3E'); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em;"
                    >
                        <option value="0">ì •ìƒ</option>
                        <option value="1">ìœ„ê¸‰</option>
                        <option value="2">ì ê²€</option>
                    </select>
                    <button onclick="submitState()" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold">
                        í™•ì¸
                    </button>
                </div>

                <div id="popupMenuForAlarm" class="hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white shadow-2xl rounded-xl p-6 z-50 w-96 max-w-[90%] transition-all duration-300 opacity-0 scale-95">
                    <div class="flex items-center mb-4">
                        <svg class="w-6 h-6 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5s-3 1.343-3 3 1.343 3 3 3z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20v-1a4 4 0 00-4-4H9a4 4 0 00-4 4v1" />
                        </svg>
                        <h3 class="text-xl font-bold text-gray-800">ì¸ê·¼ í˜„ì¥ê·¼ë¬´ì</h3>
                    </div>
                    <div class="max-w-xl mx-auto mt-6">
                        <div>
                            <ul th:each="nearestWorker : ${nearestWorker}" class="space-y-4">
                                <li class="flex items-center justify-between border border-gray-300 bg-white shadow-md rounded-xl p-4 hover:shadow-lg transition-shadow mt-2">
                                    <div class="flex flex-col text-sm sm:text-base">
                                        <span class="font-semibold text-gray-700" th:text="|ê·¼ë¬´ì: ${nearestWorker.deviceName}|"></span>
                                        <span class="text-gray-500 mt-1" th:text="|ê±°ë¦¬: ${nearestWorker.distance} Km|"></span>
                                    </div>
                                    <button th:attr="onclick='fcmAlarm(\'' + ${nearestWorker.fcmToken} + '\')'"
                                            class="ml-4 whitespace-nowrap bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors shadow">
                                        í˜¸ì¶œ
                                    </button>
                                </li>
                            </ul>
                            <div th:if="${nearestWorker == null or nearestWorker.isEmpty()}" class="text-center text-gray-500 mt-4">
                                ê·¼ë¬´ ì¤‘ì¸ ê·¼ë¬´ìê°€ ì—†ìŠµë‹ˆë‹¤
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-l font-bold text-gray-800">ğŸ” ì¶”ê°€ ì •ë³´</h3>
                    <div class="flex border-b border-gray-200">

                        <button class="tab-button-sub px-4 py-2 text-gray-600 font-medium focus:outline-none active text-blue-600 border-b-2 border-blue-600" data-tab="nearestLoc">ğŸ”— ê´€ë ¨ ì‹ í˜¸ë“±</button>
                        <button class="tab-button-sub px-4 py-2 text-gray-600 font-medium focus:outline-none" data-tab="population">ğŸ“ˆí†µí–‰ ì¸êµ¬</button>
                    </div>

                    <div class="tab-content mt-4">
                        <!-- ê´€ë ¨ ì‹ í˜¸ë“± íƒ­ -->
                        <div id="nearestLoc" class="tab-pane-sub block">
                            <ul th:each="nearestLoc : ${nearestLoc}" class="space-y-3">
                                <li class="flex items-center border-b border-gray-200 py-3">
                                    <a th:href="@{/trafficLight/trafficDetail(id=${nearestLoc.id},cid=${nearestLoc.cid})}"
                                       class="text-blue-600 hover:text-blue-800 hover:underline font-medium text-lg w-full"
                                       th:text="|TH00${nearestLoc.id} - ${nearestLoc.sName}|">
                                        TL001 - ê°•ë‚¨ì—­ ì‚¬ê±°ë¦¬
                                    </a>
                                </li>
                            </ul>
                        </div>

                        <!-- í†µí–‰ëŸ‰ íƒ­ -->
                        <div id="population" class="tab-pane-sub invisible absolute top-0 left-0 w-full opacity-0 pointer-events-none">
                            <!-- ì¶”ê°€ ì •ë³´ -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <canvas id="trafficChart" class="w-full"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>


    </section>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <div th:replace="~{layouts/alarm :: socketAlarm}"></div>

    <script th:inline="javascript">


        // íƒ­ ë©”ë‰´ ìŠ¤í¬ë¦½íŠ¸
        const tabButtonsMain = document.querySelectorAll('.tab-button-main');
        const tabPanesMain = document.querySelectorAll('.tab-pane-main');
        const tabButtonsSub = document.querySelectorAll('.tab-button-sub');
        const tabPanesSub = document.querySelectorAll('.tab-pane-sub');
        const population = [[${population}]]

        console.log("population:" + JSON.stringify(population));

        const day = population.map(item => item.day.slice(-5));
        const populationData = population.map(item => item.totalPopulation);

        tapMenu(tabButtonsSub,tabPanesSub);
        tapMenu(tabButtonsMain, tabPanesMain);


        function tapMenu(tabButtons, tabPanes) {
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ë¡œ ì´ˆê¸°í™”
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'text-blue-600', 'border-b-2', 'border-blue-600');
                        btn.classList.add('text-gray-600');
                    });

                    // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¹€ ì²˜ë¦¬ (íˆ¬ëª…í™”, ìœ„ì¹˜ ì ˆëŒ€, í´ë¦­ ë¶ˆê°€)
                    tabPanes.forEach(pane => {
                        pane.classList.add('invisible', 'absolute', 'opacity-0', 'pointer-events-none');
                        pane.classList.remove('block', 'relative', 'visible', 'opacity-100');
                    });

                    // í´ë¦­í•œ ë²„íŠ¼ì— í™œì„± ìŠ¤íƒ€ì¼ ì¶”ê°€
                    button.classList.add('active', 'text-blue-600', 'border-b-2', 'border-blue-600');
                    button.classList.remove('text-gray-600');

                    // í•´ë‹¹ íƒ­ ì½˜í…ì¸  í‘œì‹œ
                    const tabId = button.getAttribute('data-tab');
                    const selectedPane = document.getElementById(tabId);

                    selectedPane.classList.remove('invisible', 'absolute', 'opacity-0', 'pointer-events-none');
                    selectedPane.classList.add('block', 'relative', 'visible', 'opacity-100');

                    // í•„ìš” ì‹œ íŠ¹ì • íƒ­ì¼ ë•Œ ë¡œì§ ì¶”ê°€
                    if (tabId === 'map') {
                        renderMap();
                    }
                });
            });
        }

        // ì„¸ì…˜ ë° ì†Œì¼“ ì„¤ì •

        const socketId = Date.now().toString(36) + Math.random().toString(36).slice(2);
        sessionStorage.setItem('socketId', socketId);

        console.log('SocketId ID:', sessionStorage.getItem('socketId'));


        const trafficData = {
            id: [[${trafficLight.id.id}]],
            cid: [[${trafficLight.id.cid}]],
            state: [[${trafficLight.state}]],
            lat: [[${trafficLight.lat}]],
            lng: [[${trafficLight.lng}]]
        };
        console.log("trafficLight:" + JSON.stringify(trafficData));
        const idCid = trafficData.id.toString() + "&" + trafficData.cid.toString();

        const connectionInfo = {
            "socketId": socketId,
            "idCid": idCid
        };

        const room = socketId + idCid;
        JSON.stringify(connectionInfo);

        socket.emit("connection", connectionInfo);

        socket.on("successMessage", (data) => {
            console.log("íŒŒì´ì¬ê³¼ ì—°ê²° ë©”ì‹œì§€:" + data);
        });

        const nearestLoc = /*[[${nearestLoc}]]*/ [];
        let map = null;

        function renderMap() {
            if (map) {
                map.remove(); // ê¸°ì¡´ ì§€ë„ ì œê±°
            }
            // Leaflet.js ì§€ë„ ì´ˆê¸°í™”
            map = L.map('map-container').setView([trafficData.lat, trafficData.lng], 18);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            }).addTo(map);

            // ì‹ í˜¸ë“± ë°ì´í„° (ìœ„ê¸‰ ìƒíƒœë§Œ í‘œì‹œ)
            L.marker([trafficData.lat,trafficData.lng], {
                icon: L.icon({
                    iconUrl: '../img.png', // ë§ˆì»¤ ì´ë¯¸ì§€ ê²½ë¡œ
                    iconSize: [50, 50],         // ì•„ì´ì½˜ í¬ê¸° (ê°€ë¡œ, ì„¸ë¡œ)
                    iconAnchor: [25, 40]        // ì•„ì´ì½˜ì˜ ê¸°ì¤€ì  (ë§ˆì»¤ì˜ ëì  ìœ„ì¹˜)
                })
            }).addTo(map);



            L.circleMarker([trafficData.lat, trafficData.lng], {
                color: trafficData.state === 0 ? 'green'
                    : trafficData.state === 1 ? 'red'
                        : 'brown',
                radius: 8,
            })
                .addTo(map)
                .bindPopup(`ìƒíƒœ : ${trafficData.state}`);

            nearestLoc.forEach(light => {
                const markerOptions = {
                    color: light.state === 0 ? 'green'
                        : light.state === 1 ? 'red'
                            : 'brown',
                    radius: 6,
                };

                L.circleMarker([light.lat, light.lng], markerOptions)
                    .addTo(map)
                    .on('click', () => {
                        window.location.href = `/main/trafficLight/trafficDetail?id=${light.id}&cid=${light.cid}`;
                    });
            });
        }

        // ì´ˆê¸° ì§€ë„ ë Œë”ë§ ë°©ì§€ (íƒ­ ì „í™˜ ì‹œì—ë§Œ ë Œë”ë§)
        if (nearestLoc.length > 0) {
            // íƒ­ì´ 'ì§€ë„'ë¡œ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì´ˆê¸° ë Œë”ë§ì€ í•˜ì§€ ì•ŠìŒ
        }

        function togglePopup(menuId) {
            const popup = document.getElementById(menuId);
            const overlay = document.getElementById("overlay");

            if (popup.classList.contains("hidden")) {
                overlay.classList.remove('hidden');
                popup.classList.remove("hidden", "opacity-0", "scale-95");
                popup.classList.add("opacity-100", "scale-100");
            } else {
                popup.classList.remove("opacity-100", "scale-100");
                popup.classList.add("opacity-0", "scale-95");
                setTimeout(() => {
                    popup.classList.add("hidden");
                    overlay.classList.add("hidden");
                }, 300);
            }
        }

        function play() {
            console.log("room:" + room);
            socket.emit("videoCall", room);

            socket.on('frame', (data) => {
                console.log("ì˜ìƒ ìˆ˜ì‹ ");
                try {
                    document.getElementById('video-frame').src = 'data:image/jpeg;base64,' + data;
                } catch (e) {
                    console.error('Failed to set image:', e);
                }
            });

            socket.on("disconnect", () => {
                console.log("â›”ï¸ ì—°ê²° ëŠê¹€");
            });

            socket.on("connect_error", (err) => {
                console.error("âŒ ì—°ê²° ì˜¤ë¥˜:", err.message);
            });
        }

        function stop() {
            socket.emit("stopVideo", room);
            console.log("emit stop");
        }


        //***********************************************
        // íŒì—… ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const popup1 = document.getElementById("popupMenu");
            const popup2 = document.getElementById("popupMenuForAlarm");
            const overlay = document.getElementById("overlay");
            const target = event.target;

            const isOutsidePopup1 = popup1 && !popup1.contains(target);
            const isOutsidePopup2 = popup2 && !popup2.contains(target);
            const isNotTriggerButton1 = !target.matches("#alarmToWorker");
            const isNotTriggerButton2 = !target.matches("#stateChange");


            if (isOutsidePopup1 && isOutsidePopup2 && isNotTriggerButton1 && isNotTriggerButton2) {
                [popup1, popup2].forEach(popup => {
                    if (popup) {
                        popup.classList.remove("opacity-100", "scale-100");
                        popup.classList.add("opacity-0", "scale-95");
                        setTimeout(() => {
                            popup.classList.add("hidden");
                        }, 300);
                    }
                });
                if (overlay) {
                    overlay.classList.add("hidden");
                }
            }
        };
        //************************************************

        function fcmAlarm(fcmToken){

            const fcmDeviceInfo = new URLSearchParams();

            fcmDeviceInfo.append("token", fcmToken);
            fcmDeviceInfo.append("title", "TL00"+trafficData.id+"ì—ì„œ ìœ„ê¸‰ìƒí™œ ë°œìƒ");
            fcmDeviceInfo.append("body", "í˜„ì¥ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");

            fetch(`${window.Config.API_BASE_URL}:${window.Config.SPRING_BASE_PORT}/main/api/fcm/send`, {
                method: "POST",
                credentials: "include",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: fcmDeviceInfo
            })
                .then(response => response.text())
                .then(data => {
                    console.log("ì„œë²„ ì‘ë‹µ:", data);
                    //togglePopup();
                })
                .catch(error => {
                    console.error("ì„œë²„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                });
        }

        function submitState() {
            const selectedState = parseInt(document.getElementById("stateSelect").value, 10);
            const trafficInfo = {
                id: trafficData.id,
                cid: trafficData.cid,
                state: selectedState
            };

            console.log("Json ì •ë³´:", trafficInfo);

            fetch(`${window.Config.API_BASE_URL}:${window.Config.SPRING_BASE_PORT}/main/api/state_update`, {
                method: "POST",
                credentials: "include",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(trafficInfo)
            })
                .then(response => response.json())
                .then(data => {
                    console.log("ì„œë²„ ì‘ë‹µ:", data);
                    //togglePopup();
                    location.reload();
                })
                .catch(error => {
                    console.error("ì„œë²„ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                });
        }

        const ctx = document.getElementById('trafficChart').getContext('2d');
        const trafficChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: day,
                datasets: [{
                    label: 'í†µí–‰ì¸êµ¬ ( ìµœê·¼ ì¼ì£¼ì¼ )',
                    data: populationData,
                    borderColor: 'red',
                    borderWidth: 2,
                    fill: false
                }]
            },
            options: {
                plugins: {
                    legend: {
                        display: false  // ì´ê²Œ ë°”ë¡œ ë¹¨ê°„ ë„¤ëª¨ì™€ í…ìŠ¤íŠ¸ë¥¼ ì—†ì• ì¤ë‹ˆë‹¤
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>
</main>
</body>
</html>