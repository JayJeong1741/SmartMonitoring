<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ í˜¸ë“± ëª¨ë‹ˆí„°ë§ - ìƒì„¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-gray-100 font-sans">
<!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="bg-white shadow-lg fixed w-full z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <h1 class="text-2xl font-extrabold text-gray-800">ìŠ¤ë§ˆíŠ¸ ëª¨ë‹ˆí„°ë§</h1>
            </div>
            <div class="flex items-center space-x-4">
                <a th:href="@{/trafficLight/dashboard}" class="text-gray-600 hover:text-blue-500 font-semibold">ëŒ€ì‹œë³´ë“œ</a>
                <a th:href="@{/trafficLight/trafficList}" class="text-gray-600 hover:text-blue-500">ì‹ í˜¸ë“± ëª©ë¡</a>
                <a th:href="@{/user/logout}" class="text-gray-600 hover:text-blue-500">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </div>
</nav>

<!-- ì‹ í˜¸ë“± ìƒì„¸ ì •ë³´ -->
<section class="pt-20 pb-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"  th:each="trafficLight : ${trafficLight}">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">ì‹ í˜¸ë“± ìƒì„¸ ì •ë³´</h2>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- ì‹¤ì‹œê°„ ì˜ìƒ -->
        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“¹ ì‹¤ì‹œê°„ ì˜ìƒ</h3>
            <div class="relative w-full h-96 bg-gray-800 rounded-lg overflow-hidden">
                <img id="video" class="w-full h-full object-cover">
                <div class="absolute bottom-4 left-4 right-4 flex justify-center space-x-2">
                    <button class="bg-gray-700 text-white px-3 py-1 rounded-md hover:bg-gray-600">â–¶ ì¬ìƒ</button>
                    <button class="bg-gray-700 text-white px-3 py-1 rounded-md hover:bg-gray-600">âšâš ì¼ì‹œì •ì§€</button>
                </div>
            </div>
        </div>
        <!-- ìƒíƒœ ì •ë³´ ë° ì‚¬ì´ë“œë°” -->
        <div class="space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">â„¹ï¸ ìƒíƒœ ì •ë³´</h3>
                <p><strong>ì‹ í˜¸ë“± ID:</strong> <span id="trafficId" th:text="${trafficLight.id}">TL001</span></p>
                <p><strong>ìœ„ì¹˜:</strong> <span th:text="${trafficLight.sName}">ê´‘í™”ë¬¸</span></p>
                <p><strong>ìƒíƒœ:</strong> <span id="trafficStatus" class="inline-flex items-center px-2 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> ì •ìƒ</span></p>
                <p><strong>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:</strong> <span th:text="${trafficLight.lastEmergency}">2025-01-01 00:00:00</span></p>
                <button class="mt-4 w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">ì¡°ì¹˜ ì·¨í•˜ê¸°</button>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ”— ê´€ë ¨ ì‹ í˜¸ë“±</h3>
                <ul class="space-y-2">
                    <li><a href="traffic-detail.html?id=1" class="text-blue-500 hover:underline">TL001 - ê°•ë‚¨ì—­ ì‚¬ê±°ë¦¬</a></li>
                    <li><a href="traffic-detail.html?id=2" class="text-blue-500 hover:underline">TL002 - ì—­ì‚¼ì—­ ì•</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
        <!-- ì§€ë„ ë·° -->
        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“ì‹ í˜¸ë“± ìœ„ì¹˜</h3>
            <div id="map" class="w-full h-96 rounded-lg"></div>
        </div>
    </div>
</section>

<script th:inline="javascript">
    var id = /*[[${trafficLight.id.id}]]*/ 'TL001';
    var status = /*[[${trafficLight.state}]]*/ '0';
    var cid = /*[[${trafficLight.id.cid}]]*/ 'ì€í‰êµ¬';

    var lat = /*[[${trafficLight.lat}]]*/ '37.5665';
    var lng = /*[[${trafficLight.lng}]]*/ '126.9780';
    // Leaflet.js ì§€ë„ ì´ˆê¸°í™”
    const map = L.map('map').setView([lat, lng], 15); // ì„œìš¸ ì¤‘ì‹¬
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    }).addTo(map);

    // ì‹ í˜¸ë“± ë°ì´í„° (ìœ„ê¸‰ ìƒíƒœë§Œ í‘œì‹œ)
    const trafficLights = [
        { id: id, lat: lat, lng: lng, status: status, district: cid }
    ];

    trafficLights
        .filter(light => light.status ==='1')
        .forEach(light => {
            L.circleMarker([light.lat, light.lng], {
                color: 'red',
                radius: 8,
            })
                .addTo(map)
                .bindPopup(`<a href="traffic-detail.html?id=${light.id}">${light.id}</a> - ${light.status} (${light.district})`)
                .on('click', () => window.location.href = `traffic-detail.html?id=${light.id}`);
        });
    trafficLights
        .filter(light => light.status ==='0')
        .forEach(light => {
            L.circleMarker([light.lat, light.lng], {
                color: 'green',
                radius: 8,
            })
                .addTo(map)
                .bindPopup(`<a href="traffic-detail.html?id=${light.id}">${light.id}</a> - ${light.status} (${light.district})`)
                .on('click', () => window.location.href = `traffic-detail.html?id=${light.id}`);
        });
</script>

<script>
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì‹ í˜¸ë“± ID ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    const trafficId = urlParams.get('id') || 'TL001';
    document.getElementById('trafficId').textContent = trafficId;
    if (trafficId === 'TL002') {
        const statusSpan = document.getElementById('trafficStatus');
        statusSpan.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> ìœ„ê¸‰`;
        statusSpan.classList.replace('bg-green-100', 'bg-red-100');
        statusSpan.classList.replace('text-green-800', 'text-red-800');
    }
</script>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
    const socket = io("http://118.218.212.147:59726"); // Socket.IO ì„œë²„ ì£¼ì†Œ

    socket.on("connect", () => {
        console.log("âœ… ì†Œì¼“ ì—°ê²°ë¨");
    });

    socket.on("frame", (data) => {
        document.getElementById("video").src = "data:image/jpeg;base64," + data;
    });

    socket.on("disconnect", () => {
        console.log("â›”ï¸ ì—°ê²° ëŠê¹€");
    });

    socket.on("connect_error", (err) => {
        console.error("âŒ ì—°ê²° ì˜¤ë¥˜:", err.message);
    });
</script>


</body>
</html>